## Luogu P1447 [NOI2010] 能量采集

[link](https://www.luogu.com.cn/problem/P1447)

> 求 $\sum_i\sum_j2(\gcd(i,j)-1)+1$。

根据 $\mathrm{Id}=\varphi\times \mathrm I$ 反演。

$$
\begin{aligned}
&\sum_{i=1}^n\sum_{j=1}^m\gcd(i,j)\\
&=\sum_{i=1}^n\sum_{j=1}^m\sum_{d|\gcd(i,j)}\varphi(d)\\
&=\sum_{d=1}^{\min(n,m)}\varphi(d)\lfloor\frac{n}{d}\rfloor\lfloor\frac{m}{d}\rfloor\\
\end{aligned}
$$

## LOJ#2193. 「SDOI2014」数表

[link](https://loj.ac/p/2193)

> 多次询问 $n,m,a$ 求
> 
> $$
> \sum_{i=1}^n\sum_{j=1}^m[\sigma(\gcd(i,j))\le a]\sigma(\gcd(i,j))
> $$

先不考虑 $a$ 的限制，但是不拆开 $\sigma$ 以便后面处理。

（默认 $n\le m$。）

$$
\begin{aligned}
&\sum_{i=1}^n\sum_{j=1}^m\sigma(\gcd(i,j))\\
&=\sum_{d=1}^n\sigma(d)\sum_{i=1}^{\lfloor n/d\rfloor}\sum_{j=1}^{\lfloor m/d\rfloor}[\gcd(i,j)=1]\\
&=\sum_{d=1}^n\sigma(d)\sum_{k=1}^{\lfloor n/d\rfloor}\mu(k)\lfloor \frac{n}{dk}\rfloor\lfloor \frac{m}{dk}\rfloor\\
&={\color{red}{\sum_{T=1}^n}}\lfloor \frac{n}{T}\rfloor\lfloor \frac{m}{T}\rfloor\sum_{d|T}\sigma(d)\mu(\frac{T}{d})
\end{aligned}
$$

肯定是要整除分块的。

设 $f(T)=\sum_{d|T}\sigma(d)\mu(\frac{T}{d})$，发现 $\sigma(d)$ 只有 $\le a$ 时才能产生贡献。

那么离线所有询问按 $a$ 排序，按 $\sigma(d)$ 从小到大加入 $d$ 的贡献，用树状数组维护单点修改、区间查询 $f(T)$ 之和。复杂度 $\mathcal O(q\sqrt n\log n+n\log^2n)$。

注意 $\sigma$ 在 $1\dots n$ 并不单调，要排序。

[submission(2)](https://loj.ac/s/1315717)

## LOJ#2000. 「SDOI2017」数字表格

[link](https://loj.ac/p/2000)

$$
\begin{aligned}
&\prod_{i=1}^n\prod_{j=1}^mf_{\gcd(i,j)}\\
&=\prod_{d=1}^nf_d^{\sum_{i=1}^{\lfloor n/d\rfloor}\sum_{j=1}^{\lfloor m/d\rfloor}[\gcd(i,j)=1]}\\
&=\prod_{d=1}^nf_d^{\sum_{k=1}^{\lfloor n/d\rfloor}\mu(k)\left\lfloor\frac{n}{dk}\right\rfloor\left\lfloor\frac{m}{dk}\right\rfloor}\\
&=\prod_{T=1}^n\left(\prod_{d|T} f_d^{\mu(\frac{T}{d})}\right)^{\left\lfloor\frac{n}{T}\right\rfloor\left\lfloor\frac{m}{T}\right\rfloor}\\
\end{aligned}
$$

整除分块，复杂度 $\mathcal O(T\sqrt n\log\cdot)$。

[submission(1)](https://loj.ac/s/1315746)

## LOJ#2185. 「SDOI2015」约数个数和

[link](https://loj.ac/p/2185)

> $$
> \sum_{i=1}^n\sum_{j=1}^m\sigma_0(ij)
> $$

要把 $\sigma_0(ij)$ 拆开，而 $i,j$ 合并，相同质因子是“相加”、不同质因子是“相乘”的关系。

设 $i=\prod_kp_k^{\alpha_k},j=\prod_kp_k^{\beta_k}$，那么 $\sigma_0(ij)=\prod_k(\alpha_k+\beta_k+1)$。我们让 $[1,\alpha_k]$ 在 $i$ 处贡献，$[\alpha_k+1,\alpha_k+\beta_k]$ 在 $j$ 处贡献，得到

$$
\sigma_0(ij)=\sum_{x|i}\sum_{j|y}[x\perp y].
$$

$$
\begin{aligned}
&\sum_{i=1}^n\sum_{j=1}^m\sigma_0(ij)\\
&=\sum_{i=1}^n\sum_{j=1}^m\sum_{x|i}\sum_{y|j}[x\perp y]\\
&=\sum_{i=1}^n\sum_{j=1}^m\sum_{x|i}\sum_{y|j}\sum_{d|\gcd(x,y)}\mu(d)\\
&=\sum_{x=1}^n\lfloor \frac{n}{x}\rfloor\sum_{y=1}^m\lfloor \frac{n}{y}\rfloor\sum_{d|\gcd(x,y)}\mu(d)\\
&=\sum_{d=1}^n\mu(d)\left(\sum_{x=1}^{\lfloor n/d\rfloor}\lfloor \frac{n/d}{x}\rfloor\right)\left(\sum_{y=1}^{\lfloor m/d\rfloor}\lfloor \frac{m/d}{y}\rfloor\right)\\
\end{aligned}
$$

设 $f(n)=\sum_{i=1}^n\lfloor\frac{n}{i}\rfloor=\sum_{i=1}^nd(i)$，可以 $\mathcal O(n\log n)$ 或者 $\mathcal O(n)$ 预处理 $f(1\dots n)$。

整除分块，复杂度 $\mathcal O(T\sqrt n)$。

[submission(0)](https://loj.ac/s/1315839)

## 51Nod#1584 加权约数和

[link](https://vjudge.net/problem/51Nod-1584)

> $$
> \sum_{i=1}^n\sum_{j=1}^n\max(i,j)\cdot\sigma_1(ij)
> $$

首先把 $\max$ 去掉，拆为两部分

$$
F(n)-G(n)=\sum_{i=1}^n\sum_{j=1}^ii\cdot\sigma(ij)-\sum_{i=1}^ni\cdot\sigma(i^2).
$$

按照和「SDOI2015」约数个数和类似的套路拆开

$$
\sigma(ij)=\sum_{x|i}\sum_{y|j}[x\perp y]x\cdot \frac{j}{y}.
$$

第一部分：

$$
\begin{aligned}
F(n)&=\sum_{i=1}^n\sum_{j=1}^ii\cdot\sigma(ij)\\
&=\sum_{i=1}^n\sum_{j=1}^ii\sum_{x|i}\sum_{y|j}[x\perp y]x\frac{j}{y}\\
&=\sum_{i=1}^n\sum_{j=1}^ii\sum_{x|i}\sum_{y|j}\sum_{d|\gcd(x,y)}\mu(d)x\frac{j}{y}\\
&=\sum_{d=1}^n\mu(d)\sum_{i=1}^{\lfloor n/d\rfloor}id\sum_{j=1}^i\sum_{x|i}\sum_{y|j}xd\frac{jd}{yd}\\
&=\sum_{d=1}^n\mu(d)d^2\sum_{i=1}^{\lfloor n/d\rfloor}i\sum_{x|i}x\sum_{j=1}^i\sum_{y|j}\frac{j}{y}\\
&=\sum_{d=1}^n\mu(d)d^2\sum_{i=1}^{\lfloor n/d\rfloor}i\sigma(i)\sum_{j=1}^i\sigma(j)\\
\end{aligned}
$$

第二部分：

$$
\begin{aligned}
G(n)&=\sum_{i=1}^ni\cdot\sigma(i^2)\\
&=\sum_{i=1}^ni\sum_{x|i}\sum_{y|i}[x\perp y]x\frac{i}{y}\\
&=\sum_{d=1}^n\mu(d)d^2\sum_{i=1}^{\lfloor n/d\rfloor}i\sum_{x|i}\sum_{y|i}x\frac{i}{y}\\
&=\sum_{d=1}^n\mu(d)d^2\sum_{i=1}^{\lfloor n/d\rfloor}i\sigma(i)^2\\
\end{aligned}
$$

整除分块，复杂度 $\mathcal O(T\sqrt n)$。

1s 5e7 竟然 TLE 了，可见 51Nod 的评测机有多么拉垮，并且出题人数据范围的设置有多么不合理。

尝试预处理每一个 $n$ 的答案。

$$
F(n)=\sum_{i=1}^n\sum_{d|i}\mu(d)d^2\frac{i}{d}\sigma(\frac{i}{d})\sum_{j=1}^{i/d}\sigma(j)
$$

$$
G(n)=\sum_{i=1}^n\sum_{d|i}\mu(d)d^2\frac{i}{d}\sigma(\frac{i}{d})^2
$$

可以 $\mathcal O(n\log n)$ 预处理，单次 $\mathcal O(1)$ 查询。

[code(2)](https://gitee.com/renamoe/pastebin/blob/master/51Nod1584.cpp)
