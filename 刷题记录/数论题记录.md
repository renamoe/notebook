to do:

- P2480 [SDOI2010] 古代猪文
- 【WC 2014】时空穿梭
- 【SDOI 2018】反回文串
- 【LOJ 2476】蒜头的奖杯

---

## UOJ#54. 【WC2014】时空穿梭

[link](https://uoj.ac/problem/54)

考虑枚举第一个点和最后一个点的差向量 $\mathbf x=(x_1,x_2,\dots x_n)$，其中 $0\le x_i\le m_i$，那么第一个点的坐标就有 $m_i-x_i$ 种选择。

设 $m=\min_{i=1}^nm_i$。

$$
\begin{aligned}
&\sum_{\substack{\mathbf x\\0\le x_i\le m_i}}\binom{\gcd(x_1,x_2,\dots x_n)-1}{c-2}\prod_{i=1}^n(m_i-x_i)\\
&=\sum_{d=1}^m\binom{d-1}{c-2}\sum_{\substack{\mathbf x\\0\le x_i\le \lfloor m_i/d\rfloor}}[\gcd(x_1,x_2,\dots x_n)=1]\prod_{i=1}^n(m_i-x_id)\\
&=\sum_{d=1}^m\binom{d-1}{c-2}\sum_{k=1}^{\lfloor m/d\rfloor}\mu(k)\sum_{\substack{\mathbf x\\0\le x_i\le \lfloor m_i/dk\rfloor}}\prod_{i=1}^n(m_i-x_idk)\\
&=\sum_{t=1}^m\left(\sum_{d|t}\binom{d-1}{c-2}\mu(\frac{t}{d})\right)\left(\sum_{\substack{\mathbf x\\0\le x_i\le \lfloor m_i/t\rfloor}}\prod_{i=1}^n(m_i-x_it)\right)\\
&=\sum_{t=1}^m\left(\sum_{d|t}\binom{d-1}{c-2}\mu(\frac{t}{d})\right)\left(\prod_{i=1}^n\sum_{j=0}^{\lfloor m_i/t\rfloor}(m_i-jt)\right)\\
\end{aligned}
$$

设 $\displaystyle g_c(t)=\sum_{d|t}\binom{d-1}{c-2}\mu(\frac{t}{d})$ 可以 $\mathcal O(m\log m)$ 做 Dirichlet 卷积预处理。

设 $\displaystyle f(t)=\prod_{i=1}^n\sum_{j=0}^{\lfloor m_i/t\rfloor}(m_i-jt)$，固定 $\lfloor m_i/t\rfloor$ 时容易得到这是关于 $t$ 的 $n$ 次多项式。

首先整除分块，向量 $\mathbf m=(\lfloor \frac{m_1}{t}\rfloor,\lfloor \frac{m_2}{t}\rfloor,\dots \lfloor \frac{m_n}{t}\rfloor)$ 有 $\mathcal O(n\sqrt m)$ 种取值，每次暴力 $\mathcal O(n^2)$ 将多项式乘起来，然后要计算的是

$$
\begin{aligned}
&\sum_{t}g_c(t)f(t)\\
&=\sum_{t}g_c(t)\sum_{i=0}^nf_it^i\\
&=\sum_{i=0}^nf_i\sum_{t}g_c(t)t^i
\end{aligned}
$$

对应每个 $c$ 预处理组合数和 $g_c$ 以及 $g_c(t)t^i$ 前缀和。

总复杂度 $\mathcal O(cnm+cm\log m+Tn^3\sqrt m)$。

[submission(0)](https://uoj.ac/submission/519790)


