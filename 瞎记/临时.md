# 10.11

### T1

因为是排列，可以发现可能的答案是 $\mathcal O(n)$ 级别的，每次 $\mathcal O(n\log n)$ 判定。

### T2

同种字符之间的相对顺序不会改变，那么可以直接 DP，逐位放字符，状态上记录三种字符的已放个数，$\mathcal O(n^3)$。

### T3

首先有一个性质，至少有一个人转移球的个数为 $0$（均分纸牌）。

从 $0$ 为起点 DP，$f(i,j)\gets \sum_k f(i-1,k)\times(a_i-j+k)$。

只需要 $\sum_j f(i,j)$ 和 $\sum_j j\times f(i,j)$，可以改为矩阵转移，就可以前后缀和优化。

为了不算重，需要枚举第一个为 $0$ 的点为起点，需要处理两类矩阵。

### T4

好家伙，搬 JOI Final 压轴题。

~~loj 和 S2 数据怎么都这么水啊，最坏 $\mathcal O(n^2\log n+q\log n)$ 的暴力跑得比正解快多了。~~

取 $\max$ 的操作其实是告诉你，在 $t$ 时刻 $i$ 点的权值为 $a_{i-t\dots i}$ 的区间 $\max$。

先差分询问为两个前缀询问，然后从左到右维护前缀上每个时刻的答案。

维护一个单调栈，那么每加入一个点，其在时间维上的权值按照单调栈里的元素分段。

我们在单调栈弹出一个元素的时候计算它对一个区间内点的贡献，需要区间加等差数列和区间加定值。

然后只要考虑询问右端点 $r$ 时仍在单调栈中的元素。对于 $r-i > t$ 的元素贡献是一段区间的等差数列和一段区间的定值，考虑再次离线下来，建出单调栈树，在上面 DFS 时维护点到根的答案；$r-i\le t$ 的元素应特殊处理，其中只有最靠左的元素有贡献。

有很多细节，注意单调栈开头是缺少一些限制的。

贴个 [代码](https://loj.ac/s/1271422)。
