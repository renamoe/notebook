### T4

~~这个容斥真的康不懂啊。~~ 什么嘛，这个 T4 比 T2 阳间多了。

首先可以转化一下，操作 $k$ 次能够得到的排列的条件为，最长上升子段的长度 $\ge n-k$。

那么求最长上升子段的长度 $\le n-k$ 的排列数，考虑容斥，即总排列数 - 钦定 $1$ 个长为 $n-k$ 上升子段的排列数 + 钦定 $2$ 个长为 $n-k$ 上升子段的排列数……

钦定的上升子段可能会相交，需要合并。“合并”的意思大概是，一个长为 $n-k+2$ 的上升子段，可以是钦定了的两个 $n-k$ 的上升子段相交产生的，也可以是钦定了的三个 $n-k$ 的上升子段相交产生的。那么这个 $n-k+2$ 的子段的容斥系数应当是钦定 $2$ 段的容斥系数与钦定 $3$ 段的容斥系数之和。

根据合并的性质，这个容斥系数（设为 $f_i$）可以 DP，$f_1=1,f_{n-k}=-1$，然后有

$$
f_i=-1\times \sum_{j=1}^{n-k-1}f_{i-j}
$$

然后做 $\mathcal O(n^2)$ 的 DP 来将若干上升子段拼接出一个排列，在 DP 时同时计算多重集排列 $\frac{n!}{\prod a_i!}$ 的分母，设为 $g_i$，

$$
g_i=\sum_{j=1}^i g_{i-j}\times f_j\times \frac{1}{j!} 
$$

复杂度可以做到 $\mathcal O(n^3)$ 了。

进一步观察，$f_i$ 的值非常稀疏，有值的地方只有

- $f_{(n-k)\times t}=-1$；
- $f_{(n-k)\times t+1}=1$；

只考虑这些地方，复杂度就是 $\mathcal O(n^2\ln n)$ 啦。
